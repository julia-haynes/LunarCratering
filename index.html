<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moon Crater Time Animation</title>

  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      text-align: center;
    }

    #sliderContainer {
      margin-top: 20px;
    }

    input[type="range"] {
      width: 80%;
    }
  </style>
</head>

<body>
  <h2>Moon Crater Evolution (SurvivedTimeStep)</h2>

  <div id="sliderContainer">
    <input id="timeSlider" type="range" min="0" max="100" value="0" step="1">
    <div>Current timestep: <span id="timeValue">0</span></div>
  </div>

  <svg id="svg" width="800" height="800"></svg>

<script>
  const width = 800;
  const height = 800;

  const svg = d3.select("#svg");

  // === PROJECTION ===
  const projection = d3.geoOrthographic()
    .scale(350)
    .translate([width / 2, height / 2])
    .clipAngle(90)
    .rotate([-90, 0]);  // look at cratered hemisphere

  const path = d3.geoPath().projection(projection);

  // Draw sphere outline
  svg.append("path")
    .datum({ type: "Sphere" })
    .attr("fill", "#222")
    .attr("stroke", "#888")
    .attr("stroke-width", 1)
    .attr("d", path);

  // === LOAD combined.json ===
  d3.json("combined.json").then(data => {

    // Convert numeric fields
    data.forEach(d => {
      d.Longitude = +d.Longitude;
      d.Latitude  = +d.Latitude;
      d.diameter  = +d.diameter;
      d.SurvivedTimeStep = +d.SurvivedTimeStep;
    });

    // Slider min/max
    const minT = d3.min(data, d => d.SurvivedTimeStep);
    const maxT = d3.max(data, d => d.SurvivedTimeStep);

    d3.select("#timeSlider")
      .attr("min", minT)
      .attr("max", maxT);

    // Radius scale (diameter -> radius)
    const radiusScale = d3.scaleSqrt()
      .domain([0.5, 600])   // radius km range (diameter/2)
      .range([1, 40]);      // pixel radius range

    // === UPDATE FUNCTION ===
    function update(timestep) {

      const filtered = data.filter(d => d.SurvivedTimeStep === timestep);

      const circles = svg.selectAll("circle.survived")
        .data(filtered, d => d.id || (d.Longitude + "_" + d.Latitude));

      circles.exit().remove();

      circles.enter()
        .append("circle")
        .attr("class", "survived")
        .attr("fill", "white")
        .attr("opacity", 0.9)
        .merge(circles)
        .attr("r", d => radiusScale(d.diameter / 2))
        .attr("cx", d => projection([d.Longitude, d.Latitude])[0])
        .attr("cy", d => projection([d.Longitude, d.Latitude])[1]);
    }

    // Slider listener
    const slider = document.getElementById("timeSlider");
    slider.addEventListener("input", () => {
      const t = +slider.value;
      document.getElementById("timeValue").textContent = t;
      update(t);
    });

    // Start at first timestep
    slider.value = minT;
    document.getElementById("timeValue").textContent = minT;
    update(minT);

  });
</script>

</body>
</html>
